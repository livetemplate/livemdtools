"use strict";var LivepageClient=(()=>{var S=Object.defineProperty;var R=Object.getOwnPropertyDescriptor;var I=Object.getOwnPropertyNames;var N=Object.prototype.hasOwnProperty;var H=(n,e)=>{for(var t in e)S(n,t,{get:e[t],enumerable:!0})},A=(n,e,t,i)=>{if(e&&typeof e=="object"||typeof e=="function")for(let o of I(e))!N.call(n,o)&&o!==t&&S(n,o,{get:()=>e[o],enumerable:!(i=R(e,o))||i.enumerable});return n};var D=n=>A(S({},"__esModule",{value:!0}),n);var W={};H(W,{BaseBlock:()=>a,InteractiveBlock:()=>g,LivepageClient:()=>E,MessageRouter:()=>u,MonacoEditor:()=>v,OutputPanel:()=>f,PersistenceManager:()=>h,RunButton:()=>b,ServerBlock:()=>p,TinyGoExecutor:()=>y,WasmBlock:()=>C,hasEditableBlocks:()=>x,initializeWasm:()=>T,isMonacoLoaded:()=>B,loadMonaco:()=>M,preloadMonaco:()=>w});var u=class{constructor(e=!1){this.handlers=new Map;this.debug=e}register(e,t){this.handlers.has(e)&&console.warn(`[MessageRouter] Overwriting handler for block: ${e}`),this.handlers.set(e,t),this.debug&&console.log(`[MessageRouter] Registered handler for block: ${e}`)}unregister(e){this.handlers.delete(e),this.debug&&console.log(`[MessageRouter] Unregistered handler for block: ${e}`)}route(e){try{let t=typeof e=="string"?JSON.parse(e):e,{blockID:i,action:o,data:r}=t;if(o==="reload"){this.handleReload(r?.filePath||"");return}if(!i){console.error("[MessageRouter] Message missing blockID:",t);return}let s=this.handlers.get(i);if(!s){console.warn(`[MessageRouter] No handler for block: ${i}`);return}this.debug&&console.log(`[MessageRouter] Routing to ${i}:`,{action:o,data:r}),s(o,r)}catch(t){console.error("[MessageRouter] Error routing message:",t)}}handleReload(e){console.log(`[MessageRouter] Page reloading: ${e} changed`),this.showReloadNotification(e),setTimeout(()=>{window.location.reload()},500)}showReloadNotification(e){let t=document.getElementById("livepage-reload-notification");t&&t.remove();let i=document.createElement("div");i.id="livepage-reload-notification",i.innerHTML=`
      <div style="
        position: fixed;
        top: 20px;
        right: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 16px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 100000;
        font-family: system-ui, -apple-system, sans-serif;
        font-size: 14px;
        animation: slideIn 0.3s ease-out;
      ">
        <div style="display: flex; align-items: center; gap: 10px;">
          <div style="font-size: 20px;">\u{1F504}</div>
          <div>
            <div style="font-weight: 600;">File Updated</div>
            <div style="opacity: 0.9; font-size: 12px; margin-top: 2px;">${e}</div>
          </div>
        </div>
      </div>
    `;let o=document.createElement("style");o.textContent=`
      @keyframes slideIn {
        from {
          transform: translateX(400px);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }
    `,document.head.appendChild(o),document.body.appendChild(i)}createEnvelope(e,t,i={}){return{blockID:e,action:t,data:i}}getRegisteredBlocks(){return Array.from(this.handlers.keys())}clear(){this.handlers.clear(),this.debug&&console.log("[MessageRouter] Cleared all handlers")}};var h=class{constructor(e="livepage:persistence",t=!0,i=!1){this.storageKey=e,this.enabled=t&&this.isLocalStorageAvailable(),this.debug=i,!this.enabled&&t&&console.warn("[PersistenceManager] localStorage not available, persistence disabled")}isLocalStorageAvailable(){try{let e="__localStorage_test__";return localStorage.setItem(e,e),localStorage.removeItem(e),!0}catch{return!1}}saveCode(e,t){if(this.enabled)try{let i=this.loadAll();i.code[e]=t,i.timestamp=Date.now(),localStorage.setItem(this.storageKey,JSON.stringify(i)),this.debug&&console.log(`[PersistenceManager] Saved code for block: ${e}`)}catch(i){console.error("[PersistenceManager] Error saving code:",i)}}loadCode(e){if(!this.enabled)return null;try{return this.loadAll().code[e]||null}catch(t){return console.error("[PersistenceManager] Error loading code:",t),null}}loadAll(){if(!this.enabled)return{code:{},timestamp:Date.now()};try{let e=localStorage.getItem(this.storageKey);if(!e)return{code:{},timestamp:Date.now()};let t=JSON.parse(e);return!t.code||typeof t.code!="object"?(console.warn("[PersistenceManager] Invalid data structure, resetting"),{code:{},timestamp:Date.now()}):t}catch(e){return console.error("[PersistenceManager] Error loading data:",e),{code:{},timestamp:Date.now()}}}clearCode(e){if(this.enabled)try{let t=this.loadAll();delete t.code[e],t.timestamp=Date.now(),localStorage.setItem(this.storageKey,JSON.stringify(t)),this.debug&&console.log(`[PersistenceManager] Cleared code for block: ${e}`)}catch(t){console.error("[PersistenceManager] Error clearing code:",t)}}clearAll(){if(this.enabled)try{localStorage.removeItem(this.storageKey),this.debug&&console.log("[PersistenceManager] Cleared all persisted data")}catch(e){console.error("[PersistenceManager] Error clearing all data:",e)}}getPersistedBlocks(){if(!this.enabled)return[];let e=this.loadAll();return Object.keys(e.code)}hasPersistedCode(e){if(!this.enabled)return!1;let t=this.loadAll();return e in t.code}getLastUpdate(){return this.enabled?this.loadAll().timestamp:null}};var a=class{constructor(e,t,i=!1){this.element=e.element,this.metadata=e.metadata,this.persistence=t,this.initialCode=e.initialCode||"",this.currentCode=this.initialCode,this.debug=i}get id(){return this.metadata.id}get type(){return this.metadata.type}getCode(){return this.currentCode}setCode(e){this.currentCode=e,this.metadata.editable&&this.persistence.saveCode(this.id,e)}reset(){this.setCode(this.initialCode),this.debug&&console.log(`[Block:${this.id}] Reset to initial code`)}loadPersistedCode(){if(!this.metadata.editable)return this.initialCode;let e=this.persistence.loadCode(this.id);return e?(this.debug&&console.log(`[Block:${this.id}] Loaded persisted code`),e):this.initialCode}createBlockWrapper(){let e=document.createElement("div");return e.className=`livepage-block livepage-block-${this.type}`,e.dataset.blockId=this.id,e.dataset.blockType=this.type,e}log(...e){this.debug&&console.log(`[Block:${this.id}]`,...e)}error(...e){console.error(`[Block:${this.id}]`,...e)}};var p=class extends a{constructor(t,i,o=!1){super(t,i,o);this.codeElement=null}initialize(){this.log("Initializing server block"),this.codeElement=this.element.querySelector("code")||this.element,this.element.classList.add("livepage-server-block"),this.metadata.readonly&&this.element.classList.add("readonly"),this.element.dataset.blockId=this.id,this.element.dataset.language=this.metadata.language,this.render(),this.log("Server block initialized")}destroy(){this.log("Destroying server block")}handleMessage(t,i){this.log("Received message:",t,i),console.warn(`[ServerBlock:${this.id}] Received unexpected message:`,t)}render(){this.codeElement&&this.log("Rendered server block")}};var g=class extends a{constructor(t,i,o=!1){super(t,i,o);this.client=null;this.containerElement=null;this.sendMessage=null}initialize(){this.log("Initializing interactive block"),this.containerElement=this.element.querySelector("[data-interactive-content]")||this.element,this.element.classList.add("livepage-interactive-block"),this.element.dataset.blockId=this.id,this.metadata.stateRef&&(this.element.dataset.stateRef=this.metadata.stateRef),this.attachEventHandlers(),this.log("Interactive block initialized")}destroy(){this.log("Destroying interactive block"),this.client&&(this.client=null)}handleMessage(t,i){switch(this.log("Received message:",t,i),t){case"tree":i.tree&&this.containerElement&&this.updateDOM(i.tree);break;case"update":i.html&&this.containerElement&&(this.containerElement.innerHTML=i.html,this.log("DOM updated with HTML"));break;case"error":this.error("Server error:",i.message);break;default:this.log("Unknown action:",t)}}setMessageSender(t){this.sendMessage=t}updateDOM(t){if(!(!this.client||!this.containerElement))try{t.html&&(this.containerElement.innerHTML=t.html),this.log("DOM updated")}catch(i){this.error("Error updating DOM:",i)}}attachEventHandlers(){this.element&&(this.element.addEventListener("click",t=>this.handleClick(t),!0),this.element.addEventListener("submit",t=>this.handleSubmit(t),!0),this.element.addEventListener("change",t=>this.handleChange(t),!0))}handleClick(t){let o=t.target.getAttribute("lvt-click");o&&(t.preventDefault(),this.sendAction(o,{}),this.log("Click action:",o))}handleSubmit(t){let i=t.target,o=i.getAttribute("lvt-submit");if(o){t.preventDefault();let r=new FormData(i),s={};r.forEach((l,c)=>{s[c]=l}),this.sendAction(o,s),this.log("Submit action:",o,s)}}handleChange(t){let i=t.target,o=i.getAttribute("lvt-change");if(o){let r={value:i.value};this.sendAction(o,r),this.log("Change action:",o,r)}}sendAction(t,i={}){if(!this.sendMessage){this.error("Cannot send action - no message sender configured");return}this.sendMessage(this.id,t,i)}};var $="0.45.0",d=`https://cdn.jsdelivr.net/npm/monaco-editor@${$}/min`,k=null,m=null;function z(){return new Promise((n,e)=>{if(typeof window.require=="function"){n();return}let t=document.createElement("script");t.src=`${d}/vs/loader.js`,t.async=!0,t.onload=()=>n(),t.onerror=()=>e(new Error("Failed to load Monaco loader from CDN")),document.head.appendChild(t)})}function O(){window.MonacoEnvironment={getWorkerUrl:function(n,e){let t=`${d}/vs/base/worker/workerMain.js`;return e==="json"?`${d}/vs/language/json/json.worker.js`:e==="css"||e==="scss"||e==="less"?`${d}/vs/language/css/css.worker.js`:e==="html"||e==="handlebars"||e==="razor"?`${d}/vs/language/html/html.worker.js`:e==="typescript"||e==="javascript"?`${d}/vs/language/typescript/ts.worker.js`:t}}}async function M(){if(k)return k;if(m)return m;console.log("[MonacoLoader] Loading Monaco Editor from CDN...");let n=performance.now();return m=(async()=>{try{await z();let e=window.require;if(!e)throw new Error("AMD loader not available after loading");return e.config({paths:{vs:`${d}/vs`}}),O(),await new Promise((t,i)=>{e(["vs/editor/editor.main"],o=>{if(!o){i(new Error("Monaco module loaded but is undefined"));return}k=o;let r=Math.round(performance.now()-n);console.log(`[MonacoLoader] Monaco Editor loaded from CDN in ${r}ms`),t(o)})})}catch(e){throw m=null,e}})(),m}function B(){return k!==null}function w(){!k&&!m&&M().catch(n=>{console.error("[MonacoLoader] Failed to preload Monaco from CDN:",n)})}function x(){return document.querySelectorAll('[data-block-type="wasm"]').length>0}var v=class{constructor(e,t,i){this.editor=null;this.monaco=null;this.onChangeCallback=null;this.editorDiv=null;this.initPromise=null;this.container=e,this.initialCode=t,this.options=i,this.initPromise=this.initialize()}async initialize(){let e=document.createElement("div");e.className="livepage-monaco-loading",e.style.padding="2rem",e.style.textAlign="center",e.style.color="#999",e.textContent="Loading editor...",this.container.appendChild(e);try{this.monaco=await M(),e.remove(),this.editorDiv=document.createElement("div"),this.editorDiv.className="livepage-monaco-editor",this.editorDiv.style.height="300px",this.editorDiv.style.width="100%",this.container.appendChild(this.editorDiv),this.editor=this.monaco.editor.create(this.editorDiv,{value:this.initialCode,language:this.options.language,theme:this.options.theme||"vs-dark",readOnly:this.options.readonly,minimap:{enabled:this.options.minimap??!0},lineNumbers:this.options.lineNumbers!==!1?"on":"off",scrollBeyondLastLine:!1,automaticLayout:!0,fontSize:14,tabSize:4,insertSpaces:!1}),this.editor.onDidChangeModelContent(()=>{this.onChangeCallback&&this.editor&&this.onChangeCallback(this.editor.getValue())})}catch(t){console.error("[MonacoEditor] Failed to load Monaco:",t),e.textContent="Failed to load editor",e.style.color="#f44"}}async ensureReady(){this.initPromise&&await this.initPromise}getValue(){return this.editor?.getValue()||""}async setValue(e){await this.ensureReady(),this.editor?.setValue(e)}onChange(e){this.onChangeCallback=e}async setReadOnly(e){await this.ensureReady(),this.editor?.updateOptions({readOnly:e})}async focus(){await this.ensureReady(),this.editor?.focus()}async layout(){await this.ensureReady(),this.editor?.layout()}destroy(){this.editor?.dispose(),this.editor=null}async getEditor(){return await this.ensureReady(),this.editor}};var f=class{constructor(e,t=1e3,i=!0){this.lines=[];this.maxLines=t,this.autoScroll=i,this.element=this.createPanel(),e.appendChild(this.element)}createPanel(){let e=document.createElement("div");e.className="livepage-output-panel",e.innerHTML=`
      <div class="output-header">
        <span class="output-title">Output</span>
        <button class="output-clear" title="Clear output">Clear</button>
      </div>
      <div class="output-content"></div>
    `;let t=e.querySelector(".output-clear");return t&&t.addEventListener("click",()=>this.clear()),e}append(e,t){let i={type:e,text:t,timestamp:Date.now()};this.lines.push(i),this.lines.length>this.maxLines&&(this.lines=this.lines.slice(-this.maxLines)),this.render()}stdout(e){this.append("stdout",e)}stderr(e){this.append("stderr",e)}error(e){this.append("error",e)}info(e){this.append("info",e)}clear(){this.lines=[],this.render()}show(){this.element.style.display="block"}hide(){this.element.style.display="none"}render(){let e=this.element.querySelector(".output-content");if(e){e.innerHTML="";for(let t of this.lines){let i=document.createElement("div");i.className=`output-line output-${t.type}`,i.textContent=t.text,e.appendChild(i)}this.autoScroll&&(e.scrollTop=e.scrollHeight)}}getElement(){return this.element}destroy(){this.element.remove()}};var b=class{constructor(e,t="Run"){this.callback=null;this.isRunning=!1;this.element=this.createButton(t),e.appendChild(this.element)}createButton(e){let t=document.createElement("button");return t.className="livepage-run-button",t.textContent=e,t.addEventListener("click",()=>this.handleClick()),t}onClick(e){this.callback=e}async handleClick(){if(!(this.isRunning||!this.callback)){this.setRunning(!0);try{await this.callback()}catch(e){console.error("[RunButton] Error executing callback:",e)}finally{this.setRunning(!1)}}}setRunning(e){this.isRunning=e,this.element.disabled=e,e?(this.element.classList.add("running"),this.element.textContent="Running..."):(this.element.classList.remove("running"),this.element.textContent="Run")}enable(){this.element.disabled=!1}disable(){this.element.disabled=!0}getElement(){return this.element}destroy(){this.element.remove()}};var y=class{constructor(e="/api/compile",t=!1){this.serverUrl=e,this.debug=t}async execute(e){this.debug&&console.log("[TinyGoExecutor] Executing code:",e);try{let t=await fetch(this.serverUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({code:e})});if(!t.ok){let o=await t.text();return{stdout:"",stderr:o,error:`Compilation failed: ${o}`,exitCode:1}}let i=await t.arrayBuffer();return await this.executeWasm(i)}catch(t){return{stdout:"",stderr:"",error:`Execution failed: ${t instanceof Error?t.message:String(t)}`,exitCode:1}}}async executeWasm(e){let t="",i="";try{let o=new window.Go,r=console.log,s=console.error;console.log=(...c)=>{t+=c.join(" ")+`
`},console.error=(...c)=>{i+=c.join(" ")+`
`};let l=await WebAssembly.instantiate(e,o.importObject);return await o.run(l.instance),console.log=r,console.error=s,{stdout:t,stderr:i,exitCode:0}}catch(o){let r=o instanceof Error?o.message:String(o);return{stdout:t,stderr:i,error:`WASM execution failed: ${r}`,exitCode:1}}}static isSupported(){return typeof WebAssembly<"u"&&typeof window.Go<"u"}};async function T(){if(!window.Go)try{let n=document.createElement("script");n.src="/assets/wasm_exec.js",await new Promise((e,t)=>{n.onload=()=>e(),n.onerror=()=>t(new Error("Failed to load wasm_exec.js")),document.head.appendChild(n)}),console.log("[TinyGoExecutor] WASM environment initialized")}catch(n){throw console.error("[TinyGoExecutor] Failed to initialize WASM:",n),n}}var C=class extends a{constructor(t,i,o=!1){super(t,i,o);this.editor=null;this.outputPanel=null;this.runButton=null;this.executor=null;this.containerElement=null;this.editorContainer=null;this.controlsContainer=null}initialize(){this.log("Initializing WASM block"),this.currentCode=this.loadPersistedCode(),this.createBlockStructure(),this.initializeEditor(),this.initializeControls(),this.initializeExecutor(),this.log("WASM block initialized")}destroy(){this.log("Destroying WASM block"),this.editor?.destroy(),this.outputPanel?.destroy(),this.runButton?.destroy(),this.editor=null,this.outputPanel=null,this.runButton=null,this.executor=null}handleMessage(t,i){this.log("Received message:",t,i)}createBlockStructure(){this.containerElement=document.createElement("div"),this.containerElement.className="livepage-wasm-block",this.containerElement.dataset.blockId=this.id,this.editorContainer=document.createElement("div"),this.editorContainer.className="wasm-editor-container",this.containerElement.appendChild(this.editorContainer),this.controlsContainer=document.createElement("div"),this.controlsContainer.className="wasm-controls",this.containerElement.appendChild(this.controlsContainer),this.element.parentNode&&this.element.parentNode.replaceChild(this.containerElement,this.element)}initializeEditor(){this.editorContainer&&(this.editor=new v(this.editorContainer,this.currentCode,{language:this.metadata.language||"go",readonly:this.metadata.readonly||!1,theme:"vs-dark",minimap:!1,lineNumbers:!0}),this.editor.onChange(t=>{this.setCode(t)}),this.log("Editor initialized"))}initializeControls(){if(!this.controlsContainer)return;let t=document.createElement("div");t.className="wasm-buttons",this.runButton=new b(t,"Run"),this.runButton.onClick(()=>this.executeCode());let i=document.createElement("button");i.className="livepage-reset-button",i.textContent="Reset",i.addEventListener("click",()=>this.resetCode()),t.appendChild(i),this.controlsContainer.appendChild(t),this.outputPanel=new f(this.controlsContainer),this.outputPanel.hide(),this.log("Controls initialized")}initializeExecutor(){this.executor=new y("/api/compile",this.debug),this.log("Executor initialized")}async executeCode(){if(!this.editor||!this.executor||!this.outputPanel){this.error("Cannot execute - components not initialized");return}let t=this.editor.getValue();this.log("Executing code"),this.outputPanel.clear(),this.outputPanel.show(),this.outputPanel.info("Compiling and running...");try{let i=await this.executor.execute(t);this.outputPanel.clear(),i.stdout&&this.outputPanel.stdout(i.stdout),i.stderr&&this.outputPanel.stderr(i.stderr),i.error&&this.outputPanel.error(i.error),i.exitCode===0&&!i.stdout&&!i.stderr&&this.outputPanel.info("Program completed successfully (no output)"),this.log("Execution completed with exit code:",i.exitCode)}catch(i){let o=i instanceof Error?i.message:String(i);this.outputPanel.error(`Execution error: ${o}`),this.error("Execution error:",i)}}resetCode(){this.editor&&(this.editor.setValue(this.initialCode),this.setCode(this.initialCode),this.outputPanel?.clear(),this.log("Code reset to initial state"))}};var E=class{constructor(e){this.blocks=new Map;this.ws=null;this.reconnectTimer=null;this.isConnected=!1;this.options={debug:!1,persistence:!0,cdnFallback:!1,...e},this.router=new u(this.options.debug),this.persistence=new h("livepage:persistence",this.options.persistence,this.options.debug),this.options.debug&&console.log("[LivepageClient] Initialized with options:",this.options)}connect(){if(this.ws){console.warn("[LivepageClient] Already connected");return}try{this.ws=new WebSocket(this.options.wsUrl),this.ws.onopen=()=>{this.isConnected=!0,console.log("[LivepageClient] Connected to server"),this.options.onConnect?.()},this.ws.onclose=()=>{this.isConnected=!1,console.log("[LivepageClient] Disconnected from server"),this.options.onDisconnect?.(),this.scheduleReconnect()},this.ws.onerror=e=>{console.error("[LivepageClient] WebSocket error:",e),this.options.onError?.(new Error("WebSocket error"))},this.ws.onmessage=e=>{this.handleMessage(e.data)}}catch(e){console.error("[LivepageClient] Failed to connect:",e),this.options.onError?.(e)}}disconnect(){this.reconnectTimer&&(clearTimeout(this.reconnectTimer),this.reconnectTimer=null),this.ws&&(this.ws.close(),this.ws=null),this.isConnected=!1}handleMessage(e){this.options.debug&&console.log("[LivepageClient] Received message:",e),this.router.route(e)}send(e,t,i={}){if(!this.isConnected||!this.ws){console.warn("[LivepageClient] Cannot send - not connected");return}let r=JSON.stringify({blockID:e,action:t,data:i});this.options.debug&&console.log("[LivepageClient] Sending message:",r),this.ws.send(r)}scheduleReconnect(){this.reconnectTimer||(this.reconnectTimer=window.setTimeout(()=>{this.reconnectTimer=null,console.log("[LivepageClient] Attempting to reconnect..."),this.connect()},3e3))}discoverBlocks(){console.log("[LivepageClient] Discovering blocks...");let e=document.querySelectorAll("[data-livepage-block]");for(let t of Array.from(e))try{let i=this.extractMetadata(t),o=this.extractCode(t),r={element:t,metadata:i,initialCode:o};this.registerBlock(r)}catch(i){console.error("[LivepageClient] Error discovering block:",i)}console.log(`[LivepageClient] Discovered ${this.blocks.size} blocks`)}extractMetadata(e){let t=e.dataset.blockId||this.generateBlockId(),i=e.dataset.blockType||"server",o=e.dataset.language||"go",r=e.dataset.readonly==="true",s=e.dataset.editable==="true",l=e.dataset.stateRef;return{id:t,type:i,language:o,readonly:r,editable:s,stateRef:l}}extractCode(e){let t=e.querySelector("code");return t?t.textContent||"":e.textContent||""}generateBlockId(){return`block-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}registerBlock(e){let{metadata:t}=e;if(this.blocks.has(t.id)){console.warn(`[LivepageClient] Block already registered: ${t.id}`);return}let i;switch(t.type){case"server":i=new p(e,this.persistence,this.options.debug);break;case"interactive":case"lvt":i=new g(e,this.persistence,this.options.debug),i.setMessageSender((o,r,s)=>{this.send(o,r,s)});break;case"wasm":i=new C(e,this.persistence,this.options.debug);break;default:console.warn(`[LivepageClient] Unknown block type: ${t.type}`);return}i.initialize(),this.router.register(t.id,(o,r)=>{i.handleMessage(o,r)}),this.blocks.set(t.id,i),this.options.debug&&console.log(`[LivepageClient] Registered block: ${t.id} (${t.type})`)}unregisterBlock(e){let t=this.blocks.get(e);t&&(t.destroy(),this.router.unregister(e),this.blocks.delete(e),this.options.debug&&console.log(`[LivepageClient] Unregistered block: ${e}`))}getBlock(e){return this.blocks.get(e)}getBlockIds(){return Array.from(this.blocks.keys())}destroy(){console.log("[LivepageClient] Destroying client");for(let e of this.blocks.values())e.destroy();this.blocks.clear(),this.router.clear(),this.disconnect()}};var L=class{constructor(){this.steps=[];this.currentStepIndex=0;this.sidebar=null;this.bottomNav=null;this.init()}init(){document.querySelector(".livepage-nav-sidebar")||(this.parseSteps(),this.steps.length!==0&&(this.createSidebar(),this.createBottomNav(),this.setupKeyboardShortcuts(),this.setupHashNavigation(),this.setupScrollTracking(),this.initializeFromHash()))}parseSteps(){document.querySelectorAll("h2").forEach((t,i)=>{let o=t.id||this.generateId(t.textContent||"");t.id||(t.id=o),this.steps.push({id:o,title:t.textContent||"",element:t,index:i})})}generateId(e){return e.toLowerCase().replace(/[^\w\s-]/g,"").replace(/\s+/g,"-").replace(/-+/g,"-").trim()}createSidebar(){this.sidebar=document.createElement("nav"),this.sidebar.className="livepage-nav-sidebar",this.sidebar.innerHTML=`
      <div class="nav-sidebar-header">
        <h3>Contents</h3>
      </div>
      <ol class="nav-sidebar-steps">
        ${this.steps.map((e,t)=>`
          <li class="nav-step ${t===0?"active":""}" data-step="${t}">
            <a href="#${e.id}">
              <span class="step-number">${t+1}</span>
              <span class="step-title">${e.title}</span>
            </a>
          </li>
        `).join("")}
      </ol>
    `,this.sidebar.querySelectorAll(".nav-step").forEach((e,t)=>{e.addEventListener("click",i=>{i.preventDefault(),this.navigateToStep(t)})}),document.body.appendChild(this.sidebar)}createBottomNav(){this.bottomNav=document.createElement("nav"),this.bottomNav.className="livepage-nav-bottom",this.bottomNav.innerHTML=`
      <button class="nav-btn nav-prev" ${this.currentStepIndex===0?"disabled":""}>
        <span class="nav-arrow">\u2190</span>
        <span class="nav-label">Previous</span>
      </button>
      <span class="nav-progress">
        Step <span class="current-step">1</span> of <span class="total-steps">${this.steps.length}</span>
      </span>
      <button class="nav-btn nav-next" ${this.currentStepIndex===this.steps.length-1?"disabled":""}>
        <span class="nav-label">Next</span>
        <span class="nav-arrow">\u2192</span>
      </button>
    `;let e=this.bottomNav.querySelector(".nav-prev"),t=this.bottomNav.querySelector(".nav-next");e?.addEventListener("click",()=>this.navigatePrev()),t?.addEventListener("click",()=>this.navigateNext()),document.body.appendChild(this.bottomNav)}setupKeyboardShortcuts(){document.addEventListener("keydown",e=>{if(!(e.target instanceof HTMLInputElement||e.target instanceof HTMLTextAreaElement))switch(e.key){case"ArrowRight":case"ArrowDown":e.preventDefault(),this.navigateNext();break;case"ArrowLeft":case"ArrowUp":e.preventDefault(),this.navigatePrev();break}})}setupHashNavigation(){window.addEventListener("hashchange",()=>{this.handleHashChange()})}setupScrollTracking(){let e=new IntersectionObserver(t=>{t.forEach(i=>{if(i.isIntersecting){let o=i.target,r=this.steps.findIndex(s=>s.element===o);r!==-1&&r!==this.currentStepIndex&&this.updateCurrentStep(r,!1)}})},{threshold:.5,rootMargin:"-100px 0px -50% 0px"});this.steps.forEach(t=>e.observe(t.element))}initializeFromHash(){let e=window.location.hash.slice(1);if(e){let t=this.steps.findIndex(i=>i.id===e);if(t!==-1){this.navigateToStep(t);return}}this.updateCurrentStep(0,!1)}handleHashChange(){let e=window.location.hash.slice(1);if(e){let t=this.steps.findIndex(i=>i.id===e);t!==-1&&this.navigateToStep(t,!1)}}navigateToStep(e,t=!0){e<0||e>=this.steps.length||(this.updateCurrentStep(e,!0),t&&history.pushState(null,"",`#${this.steps[e].id}`))}navigateNext(){this.currentStepIndex<this.steps.length-1&&this.navigateToStep(this.currentStepIndex+1)}navigatePrev(){this.currentStepIndex>0&&this.navigateToStep(this.currentStepIndex-1)}updateCurrentStep(e,t=!0){if(this.currentStepIndex=e,this.sidebar&&this.sidebar.querySelectorAll(".nav-step").forEach((i,o)=>{i.classList.toggle("active",o===e)}),this.bottomNav){let i=this.bottomNav.querySelector(".nav-prev"),o=this.bottomNav.querySelector(".nav-next"),r=this.bottomNav.querySelector(".current-step");i&&(i.disabled=e===0),o&&(o.disabled=e===this.steps.length-1),r&&(r.textContent=String(e+1))}t&&this.scrollToStep(e)}scrollToStep(e){let t=this.steps[e];t&&t.element.scrollIntoView({behavior:"smooth",block:"start"})}getCurrentStep(){return this.currentStepIndex}getTotalSteps(){return this.steps.length}goToStep(e){this.navigateToStep(e)}};function P(){if(window.LIVEPAGE_DISABLE_AUTO_INIT){console.log("[Livepage] Auto-initialization disabled");return}let e=document.querySelector('meta[name="livepage-ws-url"]')?.content||`ws://${window.location.host}/ws`,i=document.querySelector('meta[name="livepage-debug"]')?.content==="true";x()&&(console.log("[Livepage] Preloading Monaco Editor for WASM blocks..."),w());let o=new E({wsUrl:e,debug:i,persistence:!0,onConnect:()=>console.log("[Livepage] Connected"),onDisconnect:()=>console.log("[Livepage] Disconnected"),onError:l=>console.error("[Livepage] Error:",l)});o.discoverBlocks(),o.getBlockIds().some(l=>{let c=o.getBlock(l);return c?.type==="interactive"||c?.type==="lvt"})&&o.connect(),window.livepageClient=o;let s=new L;window.livepageNavigation=s,console.log(`[Livepage] Initialized with ${o.getBlockIds().length} blocks`)}typeof window<"u"&&(document.readyState==="loading"?document.addEventListener("DOMContentLoaded",P):P());return D(W);})();
//# sourceMappingURL=livepage-client.browser.js.map
